#include "BitmapFont.h"
#include "PixelFormat.h"

// Based on Thick 8x8 (https://frostyfreeze.itch.io/pixel-bitmap-fonts-png-xml) 
static const uint8_t defaultBitmapFontData[] = {
    // 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,  //
    0b11000000, 0b11000000, 0b11000000, 0b11000000, 0b11000000, 0b00000000, 0b11000000, 0b00000000,  // !
    0b11011000, 0b11011000, 0b11011000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,  // "
    0b01101100, 0b01101100, 0b11111110, 0b01101100, 0b11111110, 0b01101100, 0b01101100, 0b00000000,  // #
    0b00110000, 0b01111100, 0b11000000, 0b01111000, 0b00001100, 0b11111000, 0b00110000, 0b00000000,  // $
    0b11000110, 0b11001100, 0b00011000, 0b00110000, 0b01100110, 0b11000110, 0b00000000, 0b00000000,  // %
    0b01110000, 0b11011000, 0b01110000, 0b01110000, 0b11011100, 0b11001000, 0b01111100, 0b00000000,  // &
    0b11000000, 0b11000000, 0b11000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,  // '
    0b00001100, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00001100, 0b00000000,  // (
    0b11000000, 0b01100000, 0b01100000, 0b01100000, 0b01100000, 0b01100000, 0b11000000, 0b00000000,  // )
    0b00000000, 0b01101100, 0b00111000, 0b11111110, 0b00111000, 0b01101100, 0b00000000, 0b00000000,  // *
    0b00000000, 0b00110000, 0b00110000, 0b11111100, 0b00110000, 0b00110000, 0b00000000, 0b00000000,  // +
    0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01100000, 0b01100000, 0b11000000,  // ,
    0b00000000, 0b00000000, 0b00000000, 0b11111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000,  // -
    0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b11000000, 0b11000000, 0b00000000,  // .
    0b00110000, 0b00110000, 0b01100000, 0b01100000, 0b01100000, 0b11000000, 0b11000000, 0b00000000,  // /

    0b01111000, 0b11001100, 0b11001100, 0b11001100, 0b11001100, 0b11001100, 0b01111000, 0b00000000,  // 0
    0b00110000, 0b01110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b01111000, 0b00000000,  // 1
    0b01111000, 0b11001100, 0b00001100, 0b00011000, 0b00110000, 0b01100000, 0b11111100, 0b00000000,  // 2
    0b01111000, 0b11001100, 0b00001100, 0b00111000, 0b00001100, 0b11001100, 0b01111000, 0b00000000,  // 3
    0b11001100, 0b11001100, 0b11001100, 0b11111100, 0b00001100, 0b00001100, 0b00001100, 0b00000000,  // 4
    0b11111100, 0b11000000, 0b11000000, 0b01111000, 0b00001100, 0b11001100, 0b01111000, 0b00000000,  // 5
    0b01111000, 0b11001100, 0b11000000, 0b11111000, 0b11001100, 0b11001100, 0b01111000, 0b00000000,  // 6
    0b11111100, 0b00001100, 0b00011000, 0b00011000, 0b00110000, 0b00110000, 0b00110000, 0b00000000,  // 7
    0b01111000, 0b11001100, 0b11001100, 0b01111000, 0b11001100, 0b11001100, 0b01111000, 0b00000000,  // 8
    0b01111000, 0b11001100, 0b11001100, 0b01111100, 0b00001100, 0b11001100, 0b01111000, 0b00000000,  // 9
    0b00000000, 0b11000000, 0b11000000, 0b00000000, 0b11000000, 0b11000000, 0b00000000, 0b00000000,  // :
    0b00000000, 0b11000000, 0b11000000, 0b00000000, 0b11000000, 0b11000000, 0b11000000, 0b11000000,  // ;
    0b00011000, 0b00110000, 0b01100000, 0b11000000, 0b01100000, 0b00110000, 0b00011000, 0b00000000,  // <
    0b00000000, 0b00000000, 0b11111100, 0b00000000, 0b11111100, 0b00000000, 0b00000000, 0b00000000,  // =
    0b01100000, 0b00110000, 0b00011000, 0b00001100, 0b00011000, 0b00110000, 0b01100000, 0b00000000,  // >
    0b01111000, 0b11001100, 0b00001100, 0b00011000, 0b00110000, 0b00000000, 0b00110000, 0b00000000,  // ?

    0b01111000, 0b11001100, 0b11001100, 0b11011100, 0b11011100, 0b11000000, 0b01111100, 0b00000000,  // @
    0b00110000, 0b01111000, 0b11001100, 0b11001100, 0b11111100, 0b11001100, 0b11001100, 0b00000000,  // A
    0b11111000, 0b11001100, 0b11001100, 0b11111000, 0b11001100, 0b11001100, 0b11111000, 0b00000000,  // B
    0b01111000, 0b11001100, 0b11000000, 0b11000000, 0b11000000, 0b11001100, 0b01111000, 0b00000000,  // C
    0b11111000, 0b11001100, 0b11001100, 0b11001100, 0b11001100, 0b11001100, 0b11111000, 0b00000000,  // D
    0b11111100, 0b11000000, 0b11000000, 0b11110000, 0b11000000, 0b11000000, 0b11111100, 0b00000000,  // E
    0b11111100, 0b11000000, 0b11000000, 0b11110000, 0b11000000, 0b11000000, 0b11000000, 0b00000000,  // F
    0b01111100, 0b11000000, 0b11000000, 0b11000000, 0b11001100, 0b11001100, 0b01111100, 0b00000000,  // G
    0b11001100, 0b11001100, 0b11001100, 0b11111100, 0b11001100, 0b11001100, 0b11001100, 0b00000000,  // H
    0b11111100, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b11111100, 0b00000000,  // I
    0b00001100, 0b00001100, 0b00001100, 0b00001100, 0b11001100, 0b11001100, 0b01111000, 0b00000000,  // J
    0b11001100, 0b11001100, 0b11011000, 0b11110000, 0b11011000, 0b11001100, 0b11001100, 0b00000000,  // K
    0b11000000, 0b11000000, 0b11000000, 0b11000000, 0b11000000, 0b11000000, 0b11111100, 0b00000000,  // L
    0b11000110, 0b11101110, 0b11111110, 0b11010110, 0b11000110, 0b11000110, 0b11000110, 0b00000000,  // M
    0b11001100, 0b11101100, 0b11111100, 0b11011100, 0b11001100, 0b11001100, 0b11001100, 0b00000000,  // N
    0b01111000, 0b11001100, 0b11001100, 0b11001100, 0b11001100, 0b11001100, 0b01111000, 0b00000000,  // O

    0b11111000, 0b11001100, 0b11001100, 0b11001100, 0b11111000, 0b11000000, 0b11000000, 0b00000000,  // P
    0b01111000, 0b11001100, 0b11001100, 0b11001100, 0b11001100, 0b11001100, 0b01111000, 0b00011100,  // Q
    0b11111000, 0b11001100, 0b11001100, 0b11111000, 0b11001100, 0b11001100, 0b11001100, 0b00000000,  // R
    0b01111100, 0b11000000, 0b11000000, 0b01111000, 0b00001100, 0b00001100, 0b11111000, 0b00000000,  // S
    0b11111100, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00000000,  // T
    0b11001100, 0b11001100, 0b11001100, 0b11001100, 0b11001100, 0b11001100, 0b01111000, 0b00000000,  // U
    0b11001100, 0b11001100, 0b11001100, 0b01111000, 0b01111000, 0b00110000, 0b00110000, 0b00000000,  // V
    0b11000110, 0b11000110, 0b11000110, 0b11010110, 0b11111110, 0b11101110, 0b11000110, 0b00000000,  // W
    0b11001100, 0b11001100, 0b01111000, 0b00110000, 0b01111000, 0b11001100, 0b11001100, 0b00000000,  // X
    0b11001100, 0b11001100, 0b11001100, 0b01111000, 0b00110000, 0b00110000, 0b00110000, 0b00000000,  // Y
    0b11111100, 0b00001100, 0b00011000, 0b00110000, 0b01100000, 0b11000000, 0b11111100, 0b00000000,  // Z
    0b00111100, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00111100, 0b00000000,  // [
    0b11000000, 0b11000000, 0b01100000, 0b01100000, 0b01100000, 0b00110000, 0b00110000, 0b00000000,  // \ /
    0b11110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b11110000, 0b00000000,  // ]
    0b00010000, 0b00111000, 0b01101100, 0b11000110, 0b00000000, 0b00000000, 0b00000000, 0b00000000,  // ^
    0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b11111100, 0b00000000,  // _

    0b00110000, 0b00110000, 0b00011000, 0b00001100, 0b00000000, 0b00000000, 0b00000000, 0b00000000,  // `
    0b00000000, 0b00000000, 0b01111000, 0b00001100, 0b01111100, 0b11001100, 0b01111100, 0b00000000,  // a
    0b11000000, 0b11000000, 0b11111000, 0b11001100, 0b11001100, 0b11001100, 0b11111000, 0b00000000,  // b
    0b00000000, 0b00000000, 0b01111100, 0b11000000, 0b11000000, 0b11000000, 0b01111100, 0b00000000,  // c
    0b00001100, 0b00001100, 0b01111100, 0b11001100, 0b11001100, 0b11001100, 0b01111100, 0b00000000,  // d
    0b00000000, 0b00000000, 0b01111000, 0b11001100, 0b11111100, 0b11000000, 0b01111100, 0b00000000,  // e
    0b00000000, 0b00111000, 0b01100000, 0b11111000, 0b01100000, 0b01100000, 0b01100000, 0b00000000,  // f
    0b00000000, 0b00000000, 0b01111100, 0b11001100, 0b11001100, 0b01111100, 0b00001100, 0b01111000,  // g
    0b11000000, 0b11000000, 0b11111000, 0b11001100, 0b11001100, 0b11001100, 0b11001100, 0b00000000,  // h
    0b00011000, 0b00000000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00000000,  // i
    0b00011000, 0b00000000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b11110000,  // j
    0b11000000, 0b11000000, 0b11001100, 0b11011000, 0b11110000, 0b11011000, 0b11001100, 0b00000000,  // k
    0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00000000,  // l
    0b00000000, 0b00000000, 0b11101100, 0b11111110, 0b11010110, 0b11000110, 0b11000110, 0b00000000,  // m
    0b00000000, 0b00000000, 0b11111000, 0b11001100, 0b11001100, 0b11001100, 0b11001100, 0b00000000,  // n
    0b00000000, 0b00000000, 0b01111000, 0b11001100, 0b11001100, 0b11001100, 0b01111000, 0b00000000,  // o

    0b00000000, 0b00000000, 0b11111000, 0b11001100, 0b11001100, 0b11111000, 0b11000000, 0b11000000,  // p
    0b00000000, 0b00000000, 0b01111100, 0b11001100, 0b11001100, 0b01111100, 0b00001100, 0b00001100,  // q
    0b00000000, 0b00000000, 0b11111000, 0b11001100, 0b11000000, 0b11000000, 0b11000000, 0b00000000,  // r
    0b00000000, 0b00000000, 0b01111100, 0b11000000, 0b01111000, 0b00001100, 0b11111000, 0b00000000,  // s
    0b00000000, 0b00110000, 0b11111100, 0b00110000, 0b00110000, 0b00110000, 0b00011100, 0b00000000,  // t
    0b00000000, 0b00000000, 0b11001100, 0b11001100, 0b11001100, 0b11001100, 0b01111100, 0b00000000,  // u
    0b00000000, 0b00000000, 0b11001100, 0b11001100, 0b11001100, 0b01111000, 0b00110000, 0b00000000,  // v
    0b00000000, 0b00000000, 0b11000110, 0b11000110, 0b11010110, 0b11111110, 0b01101100, 0b00000000,  // w
    0b00000000, 0b00000000, 0b11001100, 0b01111000, 0b00110000, 0b01111000, 0b11001100, 0b00000000,  // x
    0b00000000, 0b00000000, 0b11001100, 0b11001100, 0b11001100, 0b01111100, 0b00001100, 0b11111000,  // y
    0b00000000, 0b00000000, 0b11111100, 0b00011000, 0b00110000, 0b01100000, 0b11111100, 0b00000000,  // z
    0b00110000, 0b01100000, 0b01100000, 0b11000000, 0b01100000, 0b01100000, 0b00110000, 0b00000000,  // {
    0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000,  // |
    0b00110000, 0b00011000, 0b00011000, 0b00001100, 0b00011000, 0b00011000, 0b00110000, 0b00000000,  // }
    0b00000000, 0b00000000, 0b00000000, 0b01100110, 0b11011011, 0b11001100, 0b00000000, 0b00000000,  // ~
};

const BitmapFont DEFAULT_BITMAP_FONT = {
    .charWidth = 8,
    .charHeight = 8,
    .data = defaultBitmapFontData,
    .firstChar = '!',
    .lastChar = '~',
};

void DrawCharBitmapFont(Surface surface, int x, int y, char c, const BitmapFont* font, Color color) {
    if (c < font->firstChar || c > font->lastChar) return;
    if (color.a == 0) return;

    const uint32_t colorValue = ColorToPixel(surface.format, color);
    const int charIndex = c - font->firstChar;
    const int cw = font->charWidth;
    const int ch = font->charHeight;
    const int bpp = surface.format->bytesPerPixel;

    const uint8_t* glyphData = font->data + charIndex * ((cw * ch + 7) / 8);

    if (surface.format->aMask != 0 && color.a != 255) {  // draw character with alpha blending
        for (int row = 0; row < ch; ++row) {
            for (int col = 0; col < cw; ++col) {
                const int bitIndex = row * cw + col;
                const int byteIndex = bitIndex / 8;
                const int bit = 7 - (bitIndex % 8);

                if (glyphData[byteIndex] & (1 << bit)) {
                    const int px = x + col;
                    const int py = y + row;

                    if (px < 0 || py < 0 || px >= surface.width || py >= surface.height) continue;

                    uint8_t* pixel = (uint8_t*)surface.pixels + (py * surface.width + px) * bpp;
                    Color pixelColor = { 0 };
                    switch (bpp) {
                        case 1: {
                            pixelColor = PixelToColor(surface.format, *pixel);
                        } break;
                        case 2: {
                            pixelColor = PixelToColor(surface.format, *(uint16_t*)pixel);
                        } break;
                        case 4: {
                            pixelColor = PixelToColor(surface.format, *(uint32_t*)pixel);
                        } break;
                        default: break;
                    }

                    const uint8_t a = color.a;
                    const uint8_t invA = 255 - a;

                    const Color out = {
                        .r = (color.r * a + pixelColor.r * invA) / 255,
                        .g = (color.g * a + pixelColor.g * invA) / 255,
                        .b = (color.b * a + pixelColor.b * invA) / 255,
                        .a = 255
                        // .a = (srcColor.a + dstColor.a * (255 - srcColor.a) / 255)
                    };
                    const uint32_t outColor = ColorToPixel(surface.format, out);

                    for (int b = 0; b < bpp; ++b) {
                        pixel[b] = ((uint8_t*)&outColor)[b];
                    }
                }
            }
        }
    }
    else {  // draw character casually
        for (int row = 0; row < ch; ++row) {
            for (int col = 0; col < cw; ++col) {
                const int bitIndex = row * cw + col;
                const int byteIndex = bitIndex / 8;
                const int bit = 7 - (bitIndex % 8);

                if (glyphData[byteIndex] & (1 << bit)) {
                    const int px = x + col;
                    const int py = y + row;

                    if (px < 0 || py < 0 || px >= surface.width || py >= surface.height) continue;

                    uint8_t* pixel = (uint8_t*)surface.pixels + (py * surface.width + px) * bpp;
                    switch (bpp) {
                        case 1: {
                            *pixel = (uint8_t)colorValue;
                        } break;
                        case 2: {
                            *(uint16_t*)pixel = (uint16_t)colorValue;
                        } break;
                        case 4: {
                            *(uint32_t*)pixel = colorValue;
                        } break;
                        default: break;
                    }
                }
            }
        }
    }
}

void DrawTextBitmapFont(Surface surface, int x, int y, const char* text, const BitmapFont* font, Color color) {
    int cx = x;
    while (*text) {
        if (*text == '\n') {
            y += font->charHeight;
            cx = x;
        }
        else {
            DrawCharBitmapFont(surface, cx, y, *text, font, color);
            cx += font->charWidth;
        }
        ++text;
    }
}
